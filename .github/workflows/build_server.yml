name: Build Server Artifact

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: "Version to use for release"
        required: true
        default: "X.Y.Z"
      developmentVersion:
        description: "Version to use for new local working copy"
        required: true
        default: "X.Y.Z-SNAPSHOT"

jobs:
  build:
    name: Build & Tag Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      tag_name: ${{ steps.create_tag.outputs.tag_name || format('server-{0}', github.event.inputs.releaseVersion) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Set up JDK 25 for server (Maven)
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 25
      - name: Build common module (Maven)
        run: mvn clean install -DskipTests
        working-directory: common
      - name: Update pom.xml to releaseVersion
        run: |
          mvn -B versions:set -DnewVersion=${{ github.event.inputs.releaseVersion }} -DgenerateBackupPoms=false -f ./server/pom.xml
          mvn versions:update-child-modules -f ./server/pom.xml

      - name: Build server module (Maven)
        working-directory: server
        run: mvn clean install -DskipTests -Pbuild-prod

      - name: Upload built JAR
        uses: actions/upload-artifact@v4
        with:
          name: easylog-server-${{ github.event.inputs.releaseVersion }}.jar
          path: server/target/easylog-server-${{ github.event.inputs.releaseVersion }}.jar

      - name: Create and push release tag
        id: create_tag
        run: |
          TAG_NAME="server-${{ github.event.inputs.releaseVersion }}"
          git config --global user.name ${{ secrets.GH_USERNAME }}
          git config --global user.email ${{ secrets.GH_EMAIL }}
          git fetch origin main
          git checkout main
          git pull origin main
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

  releaseJAR:
    name: Release Server
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download built JAR
        uses: actions/download-artifact@v4
        with:
          name: easylog-server-${{ github.event.inputs.releaseVersion }}.jar
          path: server/target

      - name: Create or update Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag_name }}
          name: Release ${{ needs.build.outputs.tag_name }}
          draft: false
          prerelease: false
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Server JAR to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag_name }}
          files: |
            server/target/easylog-server-${{ github.event.inputs.releaseVersion }}.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  bump-version:
    name: Bump Development Version on main
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: Update server pom.xml to developmentVersion
        run: |
          mvn -B versions:set -DnewVersion=${{ github.event.inputs.developmentVersion }} -DgenerateBackupPoms=false -f ./server/pom.xml
          mvn versions:update-child-modules -f ./server/pom.xml

      - name: Commit developmentVersion change
        run: |
          git config --global user.name ${{ secrets.GH_USERNAME }}
          git config --global user.email ${{ secrets.GH_EMAIL }}
          git commit -m "[ci-skip] Server version updated to ${{ github.event.inputs.developmentVersion }}" || echo "No changes to commit"
          git push origin main
