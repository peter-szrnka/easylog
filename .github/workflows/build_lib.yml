name: Build Android/Kotlin Library

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: "Version to use for release"
        required: true
        default: "X.Y.Z"
      developmentVersion:
        description: "Version to use for new local working copy"
        required: true
        default: "X.Y.Z-SNAPSHOT"

jobs:
  release:
    name: Build & Tag Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      tag_name: ${{ steps.create_tag.outputs.tag_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25 for Server (Maven)
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 25

      - name: Build server module (Maven)
        run: mvn clean install -DskipTests -Ponly-common
        working-directory: server

      - name: Check Maven local path
        run: echo $HOME/.m2/repository
      - name: Upload local Maven repo
        uses: actions/upload-artifact@v4
        with:
          name: maven-local
          path: ~/.m2/repository

      - name: Set up JDK 17 for Client (Gradle)
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Grant execute permission for Gradlew
        run: chmod +x ./gradlew
        working-directory: client

      - name: Set releaseVersion
        run: |
          sed -i 's/^[[:space:]]*version *= *".*"/version = "${{ github.event.inputs.releaseVersion }}"/' ./client/client-library/build.gradle.kts
          git config --global user.name ${{ secrets.GH_USERNAME }}
          git config --global user.email ${{ secrets.GH_EMAIL }}
          git add ./client/client-library/build.gradle.kts
          git commit -m "chore: prepare release ${{ github.event.inputs.releaseVersion }}" || echo "No changes to commit"
          git push origin main

      - name: Build library (Gradle)
        run: ./gradlew :client-library:clean :client-library:build
        working-directory: client

      - name: Create and push release tag
        id: create_tag
        run: |
          TAG_NAME="android-client-${{ github.event.inputs.releaseVersion }}"
          git config --global user.name ${{ secrets.GH_USERNAME }}
          git config --global user.email ${{ secrets.GH_EMAIL }}
          git fetch origin main
          git checkout main
          git pull origin main
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      #- name: Trigger JitPack build
      #  run: |
      #    curl -X GET https://jitpack.io/com/github/peter-szrnka/easylog/android-client-${{ github.event.inputs.releaseVersion }}/build.log
  releaseAAR:
    name: Release AAR
    runs-on: ubuntu-latest
    needs: release
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Download Maven repo
        uses: actions/download-artifact@v4
        with:
          name: maven-local
          path: ~/.m2/repository

      - name: Build AAR
        run: ./gradlew :client-library:assembleRelease
        working-directory: client

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.tag_name }}
          name: Release ${{ needs.release.outputs.tag_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload AAR
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.tag_name }}
          files: |
            client/client-library/build/outputs/aar/client-library-release.aar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  bump-version:
    name: Bump Development Version on main
    runs-on: ubuntu-latest
    needs: release
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Update developmentVersion
        run: |
          sed -i 's/^[[:space:]]*version *= *".*"/version = "${{ github.event.inputs.developmentVersion }}"/' ./client/client-library/build.gradle.kts

      - name: Commit developmentVersion change
        run: |
          git config --global user.name ${{ secrets.GH_USERNAME }}
          git config --global user.email ${{ secrets.GH_EMAIL }}
          git add ./client/client-library/build.gradle.kts
          git commit -m "[ci-skip] Version updated to ${{ github.event.inputs.developmentVersion }}" || echo "No changes to commit"
          git push origin main
