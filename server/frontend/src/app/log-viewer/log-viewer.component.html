<div class="log-viewer-container">
  <div class="filters">
    <div class="websocket-container">
    @if(websocketState === 0) {
        <div class="websocket-spinner" title="loading"></div>
    } @else if(websocketState === 2) {
      <div class="websocket-online" title="online"></div>
    }
    </div>
    <input
      class="search-input"
      #search
      id="search"
      type="text"
      placeholder="Search by text"
      aria-label="Search"
      [(ngModel)]="filter"
      [disabled]="websocketState === 1"
    />

    <label>
      From:
      <input
        type="datetime-local"
        [(ngModel)]="startDate"
        (change)="onDateChange()"
        [disabled]="websocketState === 1"
      />
    </label>

    <label>
      To:
      <input
        type="datetime-local"
        [(ngModel)]="endDate"
        (change)="onDateChange()"
        [disabled]="websocketState === 1"
      />
    </label>

    <button (click)="fetchLogs()" style="height:40px;border-radius: 4px;background-color: rgb(0, 82, 136);color: white;">Search</button>
  </div>

  <ngx-datatable
    #table
    class="material"
    [rows]="messages"
    [headerHeight]="40"
    [footerHeight]="80"
    [limit]="size"
    [count]="totalElements"
    [offset]="page"
    [rowHeight]="'auto'"
    [columnMode]="'force'"
    [rowIdentity]="getRowId"
    [externalPaging]="true"
    [externalSorting]="true"
    (page)="onPage($event)"
    (sort)="onSort($event)"
    [rowClass]="getRowClass"
    [expanded]="expandedRows"
    (activate)="onActivate($event)"
    [rowDetailTemplate]="rowDetail"
    [rowExpansionIndicator]="true"
  >

    <div empty-content style="text-align: center;padding: 10px 0 10px 0;">No data to display.</div>

    <ngx-datatable-column
      name=""
      prop="fromWebSocket"
      [width]="20"
      [sortable]="false"
    >
      <ng-template let-row="row" ngx-datatable-cell-template>
        @if (row.fromWebSocket) {
          <div class="ws-indicator" title="Message from WebSocket"></div>
        }
      </ng-template>
    </ngx-datatable-column>

    <ngx-datatable-column
      name="Timestamp"
      prop="timestamp"
      [width]="150"
    >
      <ng-template let-row="row" ngx-datatable-cell-template>
        {{ row.timestamp | date: 'medium' }}
      </ng-template>
    </ngx-datatable-column>

    <ngx-datatable-column name="Message ID" prop="messageId" [width]="230"></ngx-datatable-column>
    <ngx-datatable-column name="Session ID" prop="sessionId" [width]="230"></ngx-datatable-column>
    <ngx-datatable-column name="Level" prop="logLevel" [width]="50"></ngx-datatable-column>
    <ngx-datatable-column name="Tag" prop="tag" [width]="120"></ngx-datatable-column>
    <ngx-datatable-column name="Message" prop="message" [width]="600">
      <ng-template let-row="row" ngx-datatable-cell-template>
        {{row.message }}
      </ng-template>
    </ngx-datatable-column>

    <ng-template #rowDetail let-row="row" let-expanded="expanded">
      <div class="row-detail">
        {{ row.message }}
      </div>
    </ng-template>

    <!-- TODO Finalize custom footer -->
    <ngx-datatable-footer>
      <ng-template 
        ngx-datatable-footer-template
        let-rowCount="rowCount"
            let-pageSize="pageSize"
            let-selectedCount="selectedCount"
            let-curPage="curPage"
            let-offset="offset"
      >
        <div class="datatable-footer-wrapper">
          {{ totalElements }} total | 
          <div class="pagination-controls">
            <label>
              Rows per page:
              <select [(ngModel)]="size" 
                      (change)="onPageSizeChange($event)" 
                      [disabled]="websocketState === 1">
                @for(s of pageSizeOptions; track s) {
                  <option [value]="s">{{ s }}</option>
                }
                
              </select>
            </label>
          </div>
          <div class="datatable-pager">
            <datatable-pager
              [page]="page"
              [size]="size"
              [count]="totalElements"
              [hidden]="!totalElements"
              (change)="onPage($event)">
            </datatable-pager>
          </div>
        </div>
      </ng-template>
    </ngx-datatable-footer>

  </ngx-datatable>
</div>
